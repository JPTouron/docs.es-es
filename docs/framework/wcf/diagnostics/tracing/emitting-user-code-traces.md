---
title: Emisión de trazas del código de usuario
ms.date: 03/30/2017
ms.assetid: fa54186a-8ffa-4332-b0e7-63867126fd49
ms.openlocfilehash: e8b2031165a83e24ba15a2fcf847a170f47e696a
ms.sourcegitcommit: cdb295dd1db589ce5169ac9ff096f01fd0c2da9d
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 06/09/2020
ms.locfileid: "84589297"
---
# <a name="emitting-user-code-traces"></a><span data-ttu-id="45557-102">Emisión de trazas del código de usuario</span><span class="sxs-lookup"><span data-stu-id="45557-102">Emitting User-Code Traces</span></span>

<span data-ttu-id="45557-103">Además de habilitar el seguimiento en la configuración para recopilar datos de instrumentación generados por Windows Communication Foundation (WCF), también puede emitir seguimientos mediante programación en el código de usuario.</span><span class="sxs-lookup"><span data-stu-id="45557-103">In addition to enabling tracing in configuration to collect instrumentation data generated by Windows Communication Foundation (WCF), you can also emit traces programmatically in user code.</span></span> <span data-ttu-id="45557-104">De esta manera, puede crear proactivamente datos de instrumentación que examinará más tarde con el fin de realizar un diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="45557-104">In this way, you can proactively create instrumentation data that you can peruse later for diagnostic purpose.</span></span> <span data-ttu-id="45557-105">En este tema se describe cómo hacerlo.</span><span class="sxs-lookup"><span data-stu-id="45557-105">This topic discusses how you can do this.</span></span>

<span data-ttu-id="45557-106">Además, el ejemplo de [extensión de seguimiento](../../samples/extending-tracing.md) incluye todo el código que se muestra en las secciones siguientes.</span><span class="sxs-lookup"><span data-stu-id="45557-106">In addition, the [Extending Tracing](../../samples/extending-tracing.md) sample includes all the code demonstrated in the following sections.</span></span>

## <a name="creating-a-trace-source"></a><span data-ttu-id="45557-107">Creación de un origen de seguimiento de traza</span><span class="sxs-lookup"><span data-stu-id="45557-107">Creating a Trace Source</span></span>

<span data-ttu-id="45557-108">Puede utilizar el siguiente código para crear un origen de seguimiento de traza de usuario.</span><span class="sxs-lookup"><span data-stu-id="45557-108">You can use the following code to create a user trace source.</span></span>

```csharp
TraceSource ts = new TraceSource("myUserTraceSource");
```

## <a name="creating-activities"></a><span data-ttu-id="45557-109">Creación de actividades</span><span class="sxs-lookup"><span data-stu-id="45557-109">Creating Activities</span></span>

<span data-ttu-id="45557-110">Las actividades son unidades lógicas de procesamiento.</span><span class="sxs-lookup"><span data-stu-id="45557-110">Activities are logical unit of processing.</span></span> <span data-ttu-id="45557-111">Puede crear una actividad para cada unidad de procesamiento principal en la que desee agrupar las trazas.</span><span class="sxs-lookup"><span data-stu-id="45557-111">You can create one activity for each major processing unit in which you want traces to be grouped together.</span></span> <span data-ttu-id="45557-112">Por ejemplo, puede crear una actividad para cada solicitud del servicio.</span><span class="sxs-lookup"><span data-stu-id="45557-112">For example, you can create one activity for each request to the service.</span></span> <span data-ttu-id="45557-113">Para ello, realice los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="45557-113">To do so, perform the following steps.</span></span>

1. <span data-ttu-id="45557-114">Guarde el id. de actividad dentro del ámbito.</span><span class="sxs-lookup"><span data-stu-id="45557-114">Save the activity ID in scope.</span></span>

2. <span data-ttu-id="45557-115">Cree un nuevo id. de actividad.</span><span class="sxs-lookup"><span data-stu-id="45557-115">Create a new activity ID.</span></span>

3. <span data-ttu-id="45557-116">Realice una transferencia desde la actividad del ámbito a la nueva actividad, establezca ésta última dentro del ámbito, y emita un seguimiento de traza de inicio para esa actividad.</span><span class="sxs-lookup"><span data-stu-id="45557-116">Transfer from the activity in scope to the new one, set the new activity in scope and emit a start trace for that activity.</span></span>

<span data-ttu-id="45557-117">El siguiente código muestra cómo hacerlo:</span><span class="sxs-lookup"><span data-stu-id="45557-117">The following code demonstrates how to do this.</span></span>

```csharp
Guid oldID = Trace.CorrelationManager.ActivityId;
Guid traceID = Guid.NewGuid();
ts.TraceTransfer(0, "transfer", traceID);
Trace.CorrelationManager.ActivityId = traceID; // Trace is static
ts.TraceEvent(TraceEventType.Start, 0, "Add request");
```

## <a name="emitting-traces-within-a-user-activity"></a><span data-ttu-id="45557-118">Emisión de seguimiento de trazas en una actividad de usuario</span><span class="sxs-lookup"><span data-stu-id="45557-118">Emitting Traces within a User Activity</span></span>

<span data-ttu-id="45557-119">El siguiente código emite seguimientos de traza en una actividad de usuario.</span><span class="sxs-lookup"><span data-stu-id="45557-119">The following code emits traces within a user activity.</span></span>

```csharp
double value1 = 100.00D;
double value2 = 15.99D;
ts.TraceInformation("Client sends message to Add " + value1 + ", " + value2);
double result = client.Add(value1, value2);
ts.TraceInformation("Client receives Add response '" + result + "'");
```

## <a name="stopping-the-activities"></a><span data-ttu-id="45557-120">Detención de actividades</span><span class="sxs-lookup"><span data-stu-id="45557-120">Stopping the Activities</span></span>

<span data-ttu-id="45557-121">Para detener las actividades, revierta la transferencia a la actividad anterior, detenga el id. de actividad actual, y restablezca el id. de la actividad anterior dentro del ámbito.</span><span class="sxs-lookup"><span data-stu-id="45557-121">To stop the activities, transfer back to the old activity, stop the current activity id, and reset the old activity id in scope.</span></span>

<span data-ttu-id="45557-122">El siguiente código muestra cómo hacerlo:</span><span class="sxs-lookup"><span data-stu-id="45557-122">The following code demonstrates how to do this.</span></span>

```csharp
ts.TraceTransfer(0, "transfer", oldID);
ts.TraceEvent(TraceEventType.Stop, 0, "Add request");
Trace.CorrelationManager.ActivityId = oldID;
```

## <a name="propagating-the-activity-id-to-a-service"></a><span data-ttu-id="45557-123">Propagación del id. de la actividad a un servicio</span><span class="sxs-lookup"><span data-stu-id="45557-123">Propagating the Activity ID to A Service</span></span>

<span data-ttu-id="45557-124">Si establece el atributo `propagateActivity` en `true` para el origen de seguimiento de traza `System.ServiceModel` en los archivos de configuración del servicio y del cliente, el servicio que procesa la solicitud Add se produce en la misma actividad que la definida en el cliente.</span><span class="sxs-lookup"><span data-stu-id="45557-124">If you set the `propagateActivity` attribute to `true` for the `System.ServiceModel` trace source in both the client and service configuration files, the service processing for the Add request occurs in the same activity as the one defined in the client.</span></span> <span data-ttu-id="45557-125">Si el servicio define sus propias actividades y transferencias, las trazas del servicio no aparecen en la actividad propagada por el cliente.</span><span class="sxs-lookup"><span data-stu-id="45557-125">If the service defines its own activities and transfers, the service traces do not appear in the client-propagated activity.</span></span> <span data-ttu-id="45557-126">En su lugar, aparecen en una actividad que las trazas de la transferencia ponen en correlación con la actividad cuyo id. propaga el cliente.</span><span class="sxs-lookup"><span data-stu-id="45557-126">Instead, they appear in an activity correlated by transfer traces to the activity whose ID is propagated by the client.</span></span>

> [!NOTE]
> <span data-ttu-id="45557-127">Si el `propagateActivity` atributo se establece en `true` tanto en el cliente como en el servicio, WCF establece la actividad de ambiente en el ámbito de la operación del servicio.</span><span class="sxs-lookup"><span data-stu-id="45557-127">If the `propagateActivity` attribute is set to `true` on both the client and service, the ambient activity in the operation scope of the service is set by WCF.</span></span>

<span data-ttu-id="45557-128">Puede usar el código siguiente para comprobar si WCF estableció una actividad en el ámbito.</span><span class="sxs-lookup"><span data-stu-id="45557-128">You can use the following code to check whether an activity was set in scope by WCF.</span></span>

```csharp
// Check if an activity was set in scope by WCF, if it was
// propagated from the client. If not, ( ambient activity is
// equal to Guid.Empty), create a new one.
if(Trace.CorrelationManager.ActivityId == Guid.Empty)
{
    Guid newGuid = Guid.NewGuid();
    Trace.CorrelationManager.ActivityId = newGuid;
}
// Emit your Start trace.
ts.TraceEvent(TraceEventType.Start, 0, "Add Activity");

// Emit the processing traces for that request.
serviceTs.TraceInformation("Service receives Add "
                            + n1 + ", " + n2);
// double result = n1 + n2;
serviceTs.TraceInformation("Service sends Add result" + result);

// Emit the Stop trace and exit the method scope.
ts.TraceEvent(TraceEventType.Stop, 0, "Add Activity");
// return result;
```

## <a name="tracing-exceptions-thrown-in-code"></a><span data-ttu-id="45557-129">Seguimiento de traza de las excepciones iniciadas en código</span><span class="sxs-lookup"><span data-stu-id="45557-129">Tracing Exceptions Thrown in Code</span></span>

<span data-ttu-id="45557-130">Cuando se inicia una excepción en el código, también puede hacerse un seguimiento de traza de la excepción en el nivel de advertencia, o en un nivel superior, utilizando el código siguiente.</span><span class="sxs-lookup"><span data-stu-id="45557-130">When you throw an exception in code, you can also trace the exception at Warning level or up using the following code.</span></span>

```csharp
ts.TraceEvent(TraceEventType.Warning, 0, "Throwing exception " + "exceptionMessage");
```

## <a name="viewing-user-traces-in-the-service-trace-viewer-tool"></a><span data-ttu-id="45557-131">Ver las trazas de usuario en la herramienta del visor de seguimiento de traza del servicio</span><span class="sxs-lookup"><span data-stu-id="45557-131">Viewing User Traces in the Service Trace Viewer Tool</span></span>

<span data-ttu-id="45557-132">Esta sección contiene capturas de pantallas de los seguimientos generados mediante la ejecución del ejemplo de [extensión de seguimiento](../../samples/extending-tracing.md) , cuando se ve mediante la [herramienta de visor de seguimiento de servicio (SvcTraceViewer. exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span><span class="sxs-lookup"><span data-stu-id="45557-132">This section contains screenshots of traces generated by running the [Extending Tracing](../../samples/extending-tracing.md) sample, when viewed using the [Service Trace Viewer Tool (SvcTraceViewer.exe)](../../service-trace-viewer-tool-svctraceviewer-exe.md).</span></span>

<span data-ttu-id="45557-133">En el diagrama siguiente, la actividad "agregar solicitud" creada anteriormente está seleccionada en el panel izquierdo.</span><span class="sxs-lookup"><span data-stu-id="45557-133">In the following diagram, the "Add request" activity created previously is selected on the left panel.</span></span> <span data-ttu-id="45557-134">Se enumera junto con otras tres actividades de operaciones matemáticas (dividir, restar, multiplicar) que constituyen el programa cliente de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="45557-134">It is listed with three other Math operation activities (Divide, Subtract, Multiply) that constitute the application client program.</span></span> <span data-ttu-id="45557-135">El código de usuario ha definido una nueva actividad para que cada operación aísle las apariciones de errores potenciales en diferentes solicitudes.</span><span class="sxs-lookup"><span data-stu-id="45557-135">The user code has defined one new activity for each operation to isolate potential error occurrences in different requests.</span></span>

<span data-ttu-id="45557-136">Para mostrar el uso de las transferencias en el ejemplo de [extensión de seguimiento](../../samples/extending-tracing.md) , también se crea una actividad de calculadora que encapsula las cuatro solicitudes de operación.</span><span class="sxs-lookup"><span data-stu-id="45557-136">To demonstrate the use of transfers in the [Extending Tracing](../../samples/extending-tracing.md) sample, a Calculator activity that encapsulates the four operation requests is also created.</span></span> <span data-ttu-id="45557-137">Para cada solicitud, se produce una transferencia hacia atrás y hacia delante desde la actividad de cálculo a la actividad de solicitud (la traza está seleccionada en el panel superior derecho de la imagen).</span><span class="sxs-lookup"><span data-stu-id="45557-137">For each request, there is a transfer back and forth from the Calculator activity to the request activity (trace is highlighted in the upper right panel in the figure).</span></span>

<span data-ttu-id="45557-138">Cuando se selecciona una actividad en el panel izquierdo, las trazas incluidas por esta actividad se muestran en el panel superior derecho.</span><span class="sxs-lookup"><span data-stu-id="45557-138">When you select an activity on the left panel, the traces included by this activity are shown on the upper right panel.</span></span> <span data-ttu-id="45557-139">Si `propagateActivity` está `true` en cada punto de conexión de la ruta de acceso de la solicitud, los seguimientos de la actividad de solicitud proceden de todos los procesos que participan en la solicitud.</span><span class="sxs-lookup"><span data-stu-id="45557-139">If `propagateActivity` is `true` at every endpoint in the request path, traces in the request activity are from all processes that participate in the request.</span></span> <span data-ttu-id="45557-140">En este ejemplo, puede ver trazas del cliente y del servicio en la cuarta columna del panel.</span><span class="sxs-lookup"><span data-stu-id="45557-140">In this example, you can see traces from both the client and service in the 4th column in the panel.</span></span>

<span data-ttu-id="45557-141">Esta actividad muestra el siguiente orden de procesamiento:</span><span class="sxs-lookup"><span data-stu-id="45557-141">This activity shows the following order of processing:</span></span>

1. <span data-ttu-id="45557-142">El cliente envía el mensaje a Add.</span><span class="sxs-lookup"><span data-stu-id="45557-142">Client sends message to Add.</span></span>

2. <span data-ttu-id="45557-143">El servicio recibe un mensaje de solicitud Add.</span><span class="sxs-lookup"><span data-stu-id="45557-143">Service receives Add request message.</span></span>

3. <span data-ttu-id="45557-144">El servicio envía una respuesta Add.</span><span class="sxs-lookup"><span data-stu-id="45557-144">Service sends Add response.</span></span>

4. <span data-ttu-id="45557-145">El cliente recibe la respuesta Add.</span><span class="sxs-lookup"><span data-stu-id="45557-145">Client receives Add response.</span></span>

<span data-ttu-id="45557-146">Todas estas trazas se emiten en el nivel de información.</span><span class="sxs-lookup"><span data-stu-id="45557-146">All these traces were emitted at Information level.</span></span> <span data-ttu-id="45557-147">Al hacer clic en una traza del panel superior derecho, se muestran los detalles de esa traza en el panel inferior derecho.</span><span class="sxs-lookup"><span data-stu-id="45557-147">Clicking a trace in the upper-right panel shows the details of that trace in the lower-right panel.</span></span>

<span data-ttu-id="45557-148">En el diagrama siguiente, también se observan las trazas de transferencia desde y hacia la actividad de cálculo, así como dos pares de trazas de inicio y detención por actividad de solicitud, una para el cliente y otra para el servicio (una por cada origen de seguimiento de traza).</span><span class="sxs-lookup"><span data-stu-id="45557-148">In the following diagram, we also see transfer traces from and to the Calculator activity, as well as two pairs of Start and Stop traces per request activity, one for the client and one for the service (one for each trace source).</span></span>

<span data-ttu-id="45557-149">![Visor de seguimiento: emitir seguimientos de código&#45;de usuario](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") Lista de actividades por hora de creación (panel izquierdo) y sus actividades anidadas (panel superior derecho)</span><span class="sxs-lookup"><span data-stu-id="45557-149">![Trace Viewer: Emitting User&#45;code traces](media/242c9358-475a-4baf-83f3-4227aa942fcd.gif "242c9358-475a-4baf-83f3-4227aa942fcd") List of activities by creation time (left panel) and their nested activities (upper-right panel)</span></span>

<span data-ttu-id="45557-150">Si el código del servicio inicia una excepción que da lugar a que el cliente también se inicie (por ejemplo, cuando el cliente no obtuvo la respuesta a su solicitud), los mensajes de error del servicio y del cliente se producen en la misma actividad para una correlación directa.</span><span class="sxs-lookup"><span data-stu-id="45557-150">If the service code throws an exception that causes the client to throw as well (for example, when the client did not get the response to its request), both the service and client warning or error messages occur in the same activity for direct correlation.</span></span> <span data-ttu-id="45557-151">En la siguiente imagen, el servicio inicia una excepción que indica "el servicio rechaza procesar esta solicitud en el código de usuario".</span><span class="sxs-lookup"><span data-stu-id="45557-151">In the following image, the service throws an exception that states "The service refuses to process this request in user code."</span></span> <span data-ttu-id="45557-152">El cliente también inicia una excepción que indica "el servidor no pudo procesar la solicitud debido a un error interno".</span><span class="sxs-lookup"><span data-stu-id="45557-152">The client also throws an exception that states "The server was unable to process the request due to an internal error."</span></span>

<span data-ttu-id="45557-153">Las siguientes imágenes muestran que los errores en los puntos de conexión de una solicitud determinada aparecen en la misma actividad si se propagó el ID. de actividad de solicitud:</span><span class="sxs-lookup"><span data-stu-id="45557-153">The following images shows that errors across endpoints for a given request appear in the same activity if the request activity id was propagated:</span></span>

![Captura de pantalla que muestra los errores en los puntos de conexión de una solicitud determinada.](./media/emitting-user-code-traces/trace-viewer-endpoint-errors.gif)

<span data-ttu-id="45557-155">Al hacer doble clic en la actividad de multiplicación, en el panel izquierdo, se muestra el siguiente gráfico con las trazas de la actividad de multiplicación de cada proceso implicado.</span><span class="sxs-lookup"><span data-stu-id="45557-155">Double-clicking the Multiply activity on the left panel shows the following graph, with the traces for the Multiply activity for each process involved.</span></span> <span data-ttu-id="45557-156">Podemos ver que primero tuvo lugar una advertencia en el servicio (excepción iniciada), que estuvo seguida de advertencias y errores en el cliente al no poder procesarse la solicitud.</span><span class="sxs-lookup"><span data-stu-id="45557-156">We can see a warning first occurred at the service (exception thrown), which is followed by warnings and errors on the client because the request could not be processed.</span></span> <span data-ttu-id="45557-157">Por lo tanto, podemos deducir la relación del error causal entre los extremos, y derivar la causa raíz del error.</span><span class="sxs-lookup"><span data-stu-id="45557-157">Therefore, we can imply the causal error relationship between endpoints and derive the root cause of the error.</span></span>

<span data-ttu-id="45557-158">En la imagen siguiente se muestra una vista de gráfico de correlación de errores:</span><span class="sxs-lookup"><span data-stu-id="45557-158">The following image shows a graph view of error correlation:</span></span>

![Captura de pantalla que muestra la vista de gráfico de la correlación de errores.](./media/emitting-user-code-traces/trace-viewer-error-correlation.gif)

<span data-ttu-id="45557-160">Para obtener las trazas anteriores, se establece `ActivityTracing` para los orígenes del seguimiento de traza del usuario, y `propagateActivity=true` para el origen de seguimiento de traza `System.ServiceModel`.</span><span class="sxs-lookup"><span data-stu-id="45557-160">To obtain the previous traces, we set `ActivityTracing` for the user trace sources and `propagateActivity=true` for the `System.ServiceModel` trace source.</span></span> <span data-ttu-id="45557-161">No se estableció `ActivityTracing` para el origen del seguimiento de traza `System.ServiceModel` para permitir habilitar el código de usuario a la propagación de actividad del código de usuario.</span><span class="sxs-lookup"><span data-stu-id="45557-161">We did not set `ActivityTracing` for the `System.ServiceModel` trace source to enable user code to user code activity propagation.</span></span> <span data-ttu-id="45557-162">(Cuando el seguimiento de la actividad de ServiceModel está activado, el ID. de actividad definido en el cliente no se propaga hasta el código de usuario del servicio; Sin embargo, las transferencias correlacionan las actividades de código de usuario de cliente y servicio con las actividades de WCF intermedias).</span><span class="sxs-lookup"><span data-stu-id="45557-162">(When ServiceModel activity tracing is on, the activity ID defined in the client is not propagated all the way to the service user code; Transfers, however, correlate the client and service user code activities to the intermediate WCF activities.)</span></span>

<span data-ttu-id="45557-163">La definición de actividades y la propagación de la id. de actividad permite poner directamente en correlación los errores con los extremos.</span><span class="sxs-lookup"><span data-stu-id="45557-163">Defining activities and propagating the activity ID enables us to perform direct error correlation across endpoints.</span></span> <span data-ttu-id="45557-164">De esta manera, podemos buscar más rápidamente la causa raíz de un error.</span><span class="sxs-lookup"><span data-stu-id="45557-164">In this way, we can locate the root cause of an error more quickly.</span></span>

## <a name="see-also"></a><span data-ttu-id="45557-165">Vea también</span><span class="sxs-lookup"><span data-stu-id="45557-165">See also</span></span>

- [<span data-ttu-id="45557-166">Extensión del seguimiento</span><span class="sxs-lookup"><span data-stu-id="45557-166">Extending Tracing</span></span>](../../samples/extending-tracing.md)
