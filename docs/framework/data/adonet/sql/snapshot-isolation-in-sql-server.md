---
title: Aislamiento de instantáneas en SQL Server
description: Lea información general sobre el aislamiento de instantáneas y las versiones de fila en SQL Server y aprenda a administrar la simultaneidad con niveles de aislamiento.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 7fa769448dd922925a5eccf4c85bd1840155df68
ms.sourcegitcommit: 33deec3e814238fb18a49b2a7e89278e27888291
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 06/02/2020
ms.locfileid: "84286254"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="b6cf5-103">Aislamiento de instantáneas en SQL Server</span><span class="sxs-lookup"><span data-stu-id="b6cf5-103">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="b6cf5-104">El aislamiento de instantánea mejora la simultaneidad de las aplicaciones OLTP.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-104">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="b6cf5-105">Descripción del aislamiento de instantáneas y la versión de fila</span><span class="sxs-lookup"><span data-stu-id="b6cf5-105">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="b6cf5-106">Una vez habilitado el aislamiento de instantánea, se deben mantener las versiones de fila actualizadas para cada transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-106">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="b6cf5-107">Antes de SQL Server 2019, estas versiones se almacenaban en **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-107">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="b6cf5-108">SQL Server 2019 presenta una nueva característica, una recuperación de base de datos acelerada (ADR) que requiere su propio conjunto de versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-108">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="b6cf5-109">Por tanto, a partir de SQL Server 2019, si ADR no está habilitado, las versiones de fila se mantienen en **tempdb** como siempre.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-109">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="b6cf5-110">Si el ADR está habilitado, todas las versiones de fila, relacionadas con el aislamiento de instantáneas y la ADR, se mantienen en el almacén de versiones persistente (PVS) de ADR, que se encuentra en la base de datos de usuario de un grupo de archivos que el usuario especifica.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-110">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="b6cf5-111">Un número de secuencia de transacción único identifica cada transacción, y estos números únicos se registran para cada versión de fila.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-111">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="b6cf5-112">La transacción funciona con las versiones de fila más recientes que tienen un número de secuencia antes del número de secuencia de transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-112">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="b6cf5-113">La transacción omite las versiones de fila más recientes creadas después de que se haya iniciado la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-113">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="b6cf5-114">El término "instantánea" refleja el hecho de que todas las consultas de la transacción ven la misma versión, o instantánea, de la base de datos, en función del estado de la base de datos en el momento en que se inicia la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-114">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="b6cf5-115">En una transacción de instantánea no se adquieren bloqueos en las filas o las páginas de datos subyacentes, lo que permite que se ejecuten otras transacciones sin que una transacción anterior sin completarse las bloquee.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-115">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="b6cf5-116">Las transacciones que modifican datos no bloquean las transacciones que leen datos, y las transacciones que leen datos no bloquean las transacciones que escriben datos, como ocurre normalmente en el nivel de aislamiento READ COMMITTED predeterminado de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-116">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="b6cf5-117">Este comportamiento de no bloqueo también reduce notablemente la probabilidad de que se produzcan interbloqueos en las transacciones complejas.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-117">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="b6cf5-118">El aislamiento de instantánea utiliza un modelo de simultaneidad optimista.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-118">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="b6cf5-119">Si una transacción de instantánea intenta confirmar modificaciones en los datos que han cambiado desde que se inició la transacción, esta se revertirá y se producirá un error.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-119">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="b6cf5-120">Puede evitarlo usando sugerencias UPDLOCK para las instrucciones SELECT que tienen acceso a los datos que se van a modificar.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-120">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="b6cf5-121">Visite el artículo "Sugerencias de bloqueo" de Libros en pantalla de SQL Server para obtener más información.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-121">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="b6cf5-122">El aislamiento de instantánea se debe habilitar estableciendo la opción ALLOW_SNAPSHOT_ISOLATION en ON en la base de datos antes de que se utilice en las transacciones.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-122">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="b6cf5-123">Con esto se activa el mecanismo para almacenar versiones de fila en la base de datos temporal (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="b6cf5-123">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="b6cf5-124">Debe habilitar el aislamiento de instantánea en cada base de datos en que se utilice con la instrucción ALTER DATABASE de Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-124">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="b6cf5-125">En este sentido, el aislamiento de instantánea difiere de los niveles de aislamiento tradicionales de READ COMMITTED, REPEATABLE READ, SERIALIZABLE y READ UNCOMMITTED, que no requieren ninguna configuración.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-125">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="b6cf5-126">Las siguientes instrucciones activan el aislamiento de instantánea y reemplazan el comportamiento READ COMMITTED predeterminado por SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="b6cf5-126">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="b6cf5-127">Al establecer la opción READ_COMMITTED_SNAPSHOT ON, se permite el acceso a las filas con versión en el nivel de aislamiento READ COMMITTED predeterminado.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-127">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="b6cf5-128">Si la opción READ_COMMITTED_SNAPSHOT está establecida en OFF, debe establecer explícitamente el nivel de aislamiento de instantánea en cada sesión con el fin de acceder a las filas con versiones.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-128">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="b6cf5-129">Administración de simultaneidad con niveles de aislamiento</span><span class="sxs-lookup"><span data-stu-id="b6cf5-129">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="b6cf5-130">El nivel de aislamiento en el que se ejecuta una instrucción Transact-SQL determina su bloqueo y el comportamiento de las versiones de fila.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-130">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="b6cf5-131">Un nivel de aislamiento tiene definido el ámbito en toda la conexión y, una vez que se establece en una conexión con la instrucción SET TRANSACTION ISOLATION LEVEL, continúa activo hasta que se cierra la conexión o se establece otro nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-131">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="b6cf5-132">Cuando se cierra una conexión y se devuelve al grupo, se conserva el nivel de aislamiento de la última instrucción SET TRANSACTION ISOLATION LEVEL.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-132">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="b6cf5-133">Las conexiones posteriores que reutilizan una conexión agrupada usan el nivel de aislamiento que estaba activo en el momento en que se agrupó la conexión.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-133">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="b6cf5-134">Las consultas individuales emitidas en una conexión pueden contener sugerencias de bloqueo que modifiquen el aislamiento de una única instrucción o transacción, pero no afectan al nivel de aislamiento de la conexión.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-134">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="b6cf5-135">Los niveles de aislamiento o las sugerencias de bloqueo que se establecen en procedimientos almacenados o funciones no cambian el nivel de aislamiento de la conexión que los llama y solo están activos mientras dure el procedimiento almacenado o la llamada a la función.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-135">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="b6cf5-136">En las versiones anteriores de SQL Server se admitían cuatro niveles de aislamiento definidos en el estándar SQL-92:</span><span class="sxs-lookup"><span data-stu-id="b6cf5-136">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="b6cf5-137">READ UNCOMMITTED es el nivel de aislamiento menos restrictivo porque omite los bloqueos colocados por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-137">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="b6cf5-138">Las transacciones que se ejecutan en READ UNCOMMITTED pueden leer valores de datos modificados que aún no han confirmado otras transacciones; estas se denominan lecturas de datos "sucios".</span><span class="sxs-lookup"><span data-stu-id="b6cf5-138">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="b6cf5-139">READ COMMITTED es el nivel de aislamiento predeterminado de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-139">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="b6cf5-140">Impide las lecturas de datos sucios especificando que las instrucciones no pueden leer valores de datos modificados, pero aún no confirmados por otras transacciones.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-140">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="b6cf5-141">Otras transacciones pueden seguir modificando, insertando o eliminando datos entre ejecuciones de instrucciones específicas dentro de la transacción actual, lo que da lugar a lecturas no repetibles o datos "fantasma".</span><span class="sxs-lookup"><span data-stu-id="b6cf5-141">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="b6cf5-142">REPEATABLE READ es un nivel de aislamiento más restrictivo que READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-142">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="b6cf5-143">Engloba READ COMMITTED y especifica, además, que ninguna otra transacción puede modificar o eliminar los datos leídos por la transacción actual hasta que esta se confirme.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-143">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="b6cf5-144">La simultaneidad es menor que en READ COMMITTED porque los bloqueos compartidos en los datos de lectura se mantienen mientras dure la transacción, en lugar de liberarse al final de cada instrucción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-144">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="b6cf5-145">SERIALIZABLE es el nivel de aislamiento más restrictivo, porque bloquea intervalos de claves completos y mantiene esos bloqueos hasta que la transacción finaliza.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-145">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="b6cf5-146">Engloba REPEATABLE READ y agrega la restricción de que otras transacciones no pueden insertar nuevas filas en intervalos leídos por la transacción hasta que se complete la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-146">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="b6cf5-147">Para obtener más información, vea la [Guía de versiones de fila y bloqueo de transacciones](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span><span class="sxs-lookup"><span data-stu-id="b6cf5-147">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="b6cf5-148">Extensiones del nivel de aislamiento de instantáneas</span><span class="sxs-lookup"><span data-stu-id="b6cf5-148">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="b6cf5-149">SQL Server ha incorporado extensiones a los niveles de aislamiento SQL-92 con la presentación del nivel de aislamiento SNAPSHOT y una implementación adicional de READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-149">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="b6cf5-150">El nivel de aislamiento READ_COMMITTED_SNAPSHOT puede sustituir de forma transparente a READ COMMITTED en todas las transacciones.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-150">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="b6cf5-151">El aislamiento SNAPSHOT especifica que los datos leídos en una transacción nunca reflejarán los cambios realizados por otras transacciones simultáneas.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-151">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="b6cf5-152">La transacción utiliza las versiones de fila de datos que existen cuando se inicia la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-152">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="b6cf5-153">No se aplican bloqueos a los datos cuando se leen, por lo que las transacciones SNAPSHOT no impiden que otras transacciones escriban datos.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-153">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="b6cf5-154">Las transacciones que escriben datos no bloquean la lectura de datos de las transacciones de tipo SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-154">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="b6cf5-155">Debe habilitar el aislamiento de instantánea estableciendo la opción de base de datos ALLOW_SNAPSHOT_ISOLATION para poder usarlo.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-155">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="b6cf5-156">La opción de base de datos READ_COMMITTED_SNAPSHOT determina el comportamiento del nivel de aislamiento READ COMMITTED predeterminado cuando el aislamiento de instantánea está habilitado en una base de datos.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-156">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="b6cf5-157">Si no especifica explícitamente READ_COMMITTED_SNAPSHOT en ON, READ COMMITTED se aplica a todas las transacciones implícitas.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-157">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="b6cf5-158">Esto produce el mismo comportamiento que si se establece READ_COMMITTED_SNAPSHOT en OFF (el valor predeterminado).</span><span class="sxs-lookup"><span data-stu-id="b6cf5-158">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="b6cf5-159">Cuando READ_COMMITTED_SNAPSHOT OFF está en vigor, el Motor de base de datos utiliza bloqueos compartidos para aplicar el nivel de aislamiento predeterminado.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-159">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="b6cf5-160">Si establece la opción de base de datos READ_COMMITTED_SNAPSHOT en ON, el Motor de base de datos utilizará las versiones de fila y el aislamiento de instantánea de forma predeterminada, en lugar de usar bloqueos para proteger los datos.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-160">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="b6cf5-161">Cómo funcionan el aislamiento de instantáneas y la versión de fila</span><span class="sxs-lookup"><span data-stu-id="b6cf5-161">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="b6cf5-162">Cuando se habilita el nivel de aislamiento SNAPSHOT, cada vez que se actualiza una fila, el motor de base de datos de SQL Server almacena una copia de la fila original en **tempdb** y agrega un número de secuencia de transacción a la fila.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-162">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="b6cf5-163">A continuación se presenta la secuencia de eventos que se produce:</span><span class="sxs-lookup"><span data-stu-id="b6cf5-163">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="b6cf5-164">Se inicia una nueva transacción y se le asigna un número de secuencia de transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-164">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="b6cf5-165">El motor de base de datos lee una fila de la transacción y recupera la versión de fila de **tempdb** cuyo número de secuencia se aproxima más a, y es inferior a, el número de la secuencia de transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-165">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="b6cf5-166">El Motor de base de datos comprueba si el número de secuencia de transacción no está en la lista de números de secuencia de transacción de las transacciones no confirmadas activas cuando se inició la transacción de instantánea.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-166">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="b6cf5-167">La transacción lee la versión de la fila de **tempdb** que era la actual al inicio de la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-167">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="b6cf5-168">Esta no verá las nuevas filas insertadas una vez iniciada la transacción porque esos valores de número de secuencia serán mayores que el valor del número de secuencia de transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-168">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="b6cf5-169">La transacción actual ve las filas que se han eliminado tras su inicio, porque hay una versión de fila en **tempdb** con un valor de número de secuencia inferior.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-169">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="b6cf5-170">El efecto real del aislamiento de instantánea es que la transacción ve todos los datos tal como se encontraban en el inicio de la transacción, sin tener en cuenta ni colocar los bloqueos en las tablas subyacentes.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-170">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="b6cf5-171">Esta acción mejorar el rendimiento en situaciones en las que hay contención.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-171">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="b6cf5-172">Una transacción de instantánea siempre utiliza el control de simultaneidad optimista, que retiene los bloqueos que impiden que otras transacciones actualicen las filas.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-172">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="b6cf5-173">Si una transacción de instantánea intenta confirmar una actualización en una fila que se cambió una vez iniciada la transacción, la transacción se revierte y se produce un error.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-173">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="b6cf5-174">Trabajo con aislamiento de instantáneas en ADO.NET</span><span class="sxs-lookup"><span data-stu-id="b6cf5-174">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="b6cf5-175">La clase <xref:System.Data.SqlClient.SqlTransaction> admite el aislamiento de instantánea en ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-175">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="b6cf5-176">Si se ha habilitado en una base de datos el aislamiento de instantánea pero no se ha configurado como READ_COMMITTED_SNAPSHOT ON, debe iniciar una <xref:System.Data.SqlClient.SqlTransaction> mediante el valor de enumeración **IsolationLevel.Snapshot** cuando llame al método <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A>.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-176">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="b6cf5-177">En este fragmento de código se da por hecho que la conexión es un objeto <xref:System.Data.SqlClient.SqlConnection> abierto.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-177">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="b6cf5-178">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="b6cf5-178">Example</span></span>  
 <span data-ttu-id="b6cf5-179">En el ejemplo siguiente se muestra cómo se comportan los distintos niveles de aislamiento intentando acceder a los datos bloqueados; no está diseñado para usarse en el código de producción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-179">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="b6cf5-180">El código conecta a la base de datos de ejemplo **AdventureWorks** de SQL Server, crea una tabla denominada **TestSnapshot** e inserta una fila de datos.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-180">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="b6cf5-181">El código usa la instrucción ALTER DATABASE de Transact-SQL para activar el aislamiento de instantánea en la base de datos, pero no establece la opción READ_COMMITTED_SNAPSHOT, lo que deja activo el comportamiento del nivel de aislamiento READ COMMITTED predeterminado.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-181">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="b6cf5-182">El código realiza las siguientes acciones:</span><span class="sxs-lookup"><span data-stu-id="b6cf5-182">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="b6cf5-183">Inicia sqlTransaction1 sin completarla, que usa el nivel de aislamiento SERIALIZABLE para iniciar una transacción de actualización.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-183">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="b6cf5-184">Con esto, se bloquea la tabla.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-184">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="b6cf5-185">Se abre una segunda conexión y se inicia una segunda transacción con el nivel de aislamiento SNAPSHOT para leer los datos de la tabla **TestSnapshot**.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-185">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="b6cf5-186">Dado que el aislamiento de instantánea está habilitado, esta transacción puede leer los datos que existían antes de que se iniciara sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-186">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="b6cf5-187">Se abre una tercera conexión y se inicia una transacción con el nivel de aislamiento READ COMMITTED para intentar leer los datos de la tabla.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-187">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="b6cf5-188">En este caso, el código no puede leer los datos porque no puede leer más allá de los bloqueos colocados en la tabla en la primera transacción y se agota el tiempo de espera. Se produciría el mismo resultado si se utilizaran los niveles de aislamiento REPEATable READ y SERIALIZABLE, ya que estos niveles de aislamiento tampoco pueden leer más allá de los bloqueos colocados en la primera transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-188">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="b6cf5-189">Se abre una cuarta conexión y se inicia una transacción con el nivel de aislamiento READ UNCOMMITTED, que realiza una lectura de datos sucios del valor sin confirmar en sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-189">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="b6cf5-190">Este valor nunca puede existir realmente en la base de datos si la primera transacción no se confirma.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-190">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="b6cf5-191">Se revierte la primera transacción y se procede a una limpieza con la eliminación de la tabla **TestSnapshot** y la desactivación del aislamiento de instantánea en la base de datos **AdventureWorks**.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-191">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="b6cf5-192">En los ejemplos siguientes se usa la misma cadena de conexión con la agrupación de conexiones desactivada.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-192">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="b6cf5-193">Si una conexión se agrupa, al restablecer su nivel de aislamiento no se restablece el nivel de aislamiento en el servidor.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-193">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="b6cf5-194">Como resultado, las conexiones posteriores que usan la misma conexión interna agrupada se inician con sus niveles de aislamiento establecidos en el de la conexión agrupada.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-194">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="b6cf5-195">Una alternativa a desactivar la agrupación de conexiones es establecer el nivel de aislamiento explícitamente en cada conexión.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-195">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="b6cf5-196">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="b6cf5-196">Example</span></span>  
 <span data-ttu-id="b6cf5-197">En el ejemplo siguiente se muestra el comportamiento del aislamiento de instantánea cuando se modifican los datos.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-197">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="b6cf5-198">El código realiza las siguientes acciones:</span><span class="sxs-lookup"><span data-stu-id="b6cf5-198">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="b6cf5-199">Conecta a la base de datos de ejemplo **AdventureWorks** y habilita el aislamiento SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-199">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="b6cf5-200">Crea una tabla denominada **TestSnapshotUpdate** e inserta tres filas de datos de ejemplo.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-200">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="b6cf5-201">Inicia sqlTransaction1 sin completarla, mediante el aislamiento SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-201">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="b6cf5-202">En la transacción se seleccionan tres filas de datos.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-202">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="b6cf5-203">Crea una segunda **SqlConnection** a **AdventureWorks** y crea una segunda transacción con el nivel de aislamiento READ COMMITTED que actualiza un valor de una de las filas seleccionadas en sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-203">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="b6cf5-204">Confirma sqlTransaction2.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-204">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="b6cf5-205">Vuelve a sqlTransaction1 e intenta actualizar la misma fila que sqlTransaction1 ya confirmó.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-205">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="b6cf5-206">Se produce el error 3960 y sqlTransaction1 se revierte automáticamente.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-206">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="b6cf5-207">**SqlException.Number** y **SqlException.Message** se muestran en la ventana Consola.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-207">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="b6cf5-208">Ejecuta el código de limpieza para desactivar el aislamiento de instantánea en **AdventureWorks** y eliminar la tabla **TestSnapshotUpdate**.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-208">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="b6cf5-209">Uso de sugerencias de bloqueo con aislamiento de instantáneas</span><span class="sxs-lookup"><span data-stu-id="b6cf5-209">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="b6cf5-210">En el ejemplo anterior, la primera transacción selecciona los datos, y una segunda transacción actualiza los datos antes de que se pueda completar la primera, lo que provoca un conflicto de actualización cuando la primera transacción intenta actualizar la misma fila.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-210">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="b6cf5-211">Puede reducir la posibilidad de conflictos de actualización en transacciones de instantánea de ejecución prolongada proporcionando sugerencias de bloqueo al inicio de la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-211">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="b6cf5-212">La siguiente instrucción SELECT usa la sugerencia UPDLOCK para bloquear las filas seleccionadas:</span><span class="sxs-lookup"><span data-stu-id="b6cf5-212">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="b6cf5-213">Al usar la sugerencia de bloqueo UPDLOCK, se bloquean las filas que intentan actualizar las filas antes de que se complete la primera transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-213">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="b6cf5-214">Esto garantiza que las filas seleccionadas no tengan conflictos cuando se actualicen posteriormente en la transacción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-214">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="b6cf5-215">Consulte el artículo "Sugerencias de bloqueo" en Libros en pantalla de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-215">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="b6cf5-216">Si la aplicación tiene muchos conflictos, es posible que el aislamiento de instantánea no sea la mejor opción.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-216">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="b6cf5-217">Las sugerencias solo deben usarse cuando realmente se necesite.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-217">Hints should only be used when really needed.</span></span> <span data-ttu-id="b6cf5-218">La aplicación no debe estar diseñada para que funcionen dependiendo constantemente de las sugerencias de bloqueo.</span><span class="sxs-lookup"><span data-stu-id="b6cf5-218">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="b6cf5-219">Consulte también</span><span class="sxs-lookup"><span data-stu-id="b6cf5-219">See also</span></span>

- [<span data-ttu-id="b6cf5-220">SQL Server y ADO.NET</span><span class="sxs-lookup"><span data-stu-id="b6cf5-220">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="b6cf5-221">Información general de ADO.NET</span><span class="sxs-lookup"><span data-stu-id="b6cf5-221">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="b6cf5-222">Guía de versiones de fila y bloqueo de transacciones</span><span class="sxs-lookup"><span data-stu-id="b6cf5-222">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
