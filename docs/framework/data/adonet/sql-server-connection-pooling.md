---
title: Agrupación de conexiones de SQL Server
description: Obtenga información sobre cómo ADO.NET minimiza el costo de abrir conexiones mediante SQL Server agrupación de conexiones, lo que reduce la sobrecarga de las nuevas conexiones.
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 7e51d44e-7c4e-4040-9332-f0190fe36f07
ms.openlocfilehash: 96d9e9a7e43f71dc30bd2d7a7f1902238941d471
ms.sourcegitcommit: 5b475c1855b32cf78d2d1bbb4295e4c236f39464
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 09/24/2020
ms.locfileid: "91156360"
---
# <a name="sql-server-connection-pooling-adonet"></a><span data-ttu-id="03390-103">Agrupación de conexiones de SQL Server (ADO.NET)</span><span class="sxs-lookup"><span data-stu-id="03390-103">SQL Server Connection Pooling (ADO.NET)</span></span>

<span data-ttu-id="03390-104">La conexión a un servidor de bases de datos suele constar de varios pasos que requieren mucho tiempo.</span><span class="sxs-lookup"><span data-stu-id="03390-104">Connecting to a database server typically consists of several time-consuming steps.</span></span> <span data-ttu-id="03390-105">Se debe establecer un canal físico, como un socket o una canalización con nombre, debe tener lugar el protocolo de enlace con el servidor, se debe analizar la información de la cadena de conexión, el servidor debe autenticar la conexión, se deben ejecutar comprobaciones para la inscripción en la transacción actual, etc.</span><span class="sxs-lookup"><span data-stu-id="03390-105">A physical channel such as a socket or a named pipe must be established, the initial handshake with the server must occur, the connection string information must be parsed, the connection must be authenticated by the server, checks must be run for enlisting in the current transaction, and so on.</span></span>  
  
 <span data-ttu-id="03390-106">En la práctica, la mayoría de las aplicaciones solamente utilizan unas cuantas configuraciones diferentes para las conexiones.</span><span class="sxs-lookup"><span data-stu-id="03390-106">In practice, most applications use only one or a few different configurations for connections.</span></span> <span data-ttu-id="03390-107">Esto significa que durante la ejecución de la aplicación, muchas conexiones idénticas se abrirán y cerrarán de forma repetida.</span><span class="sxs-lookup"><span data-stu-id="03390-107">This means that during application execution, many identical connections will be repeatedly opened and closed.</span></span> <span data-ttu-id="03390-108">Para minimizar el costo de la apertura de conexiones, ADO.NET usa una técnica de optimización denominada *agrupación*de conexiones.</span><span class="sxs-lookup"><span data-stu-id="03390-108">To minimize the cost of opening connections, ADO.NET uses an optimization technique called *connection pooling*.</span></span>  
  
 <span data-ttu-id="03390-109">La agrupación de conexiones reduce el número de veces que es necesario abrir nuevas conexiones.</span><span class="sxs-lookup"><span data-stu-id="03390-109">Connection pooling reduces the number of times that new connections must be opened.</span></span> <span data-ttu-id="03390-110">El *concentrador* mantiene la propiedad de la conexión física.</span><span class="sxs-lookup"><span data-stu-id="03390-110">The *pooler* maintains ownership of the physical connection.</span></span> <span data-ttu-id="03390-111">Para administrar las conexiones, mantiene un conjunto de conexiones activas para cada configuración de conexión dada.</span><span class="sxs-lookup"><span data-stu-id="03390-111">It manages connections by keeping alive a set of active connections for each given connection configuration.</span></span> <span data-ttu-id="03390-112">Cada vez que un usuario llama a `Open` en una conexión, el agrupador comprueba si hay una conexión disponible en el grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-112">Whenever a user calls `Open` on a connection, the pooler looks for an available connection in the pool.</span></span> <span data-ttu-id="03390-113">Si hay disponible una conexión agrupada, la devuelve a la persona que llama en lugar de abrir una nueva.</span><span class="sxs-lookup"><span data-stu-id="03390-113">If a pooled connection is available, it returns it to the caller instead of opening a new connection.</span></span> <span data-ttu-id="03390-114">Cuando la aplicación llama a `Close` en la conexión, el agrupador la devuelve al conjunto agrupado de conexiones activas en lugar de cerrarla.</span><span class="sxs-lookup"><span data-stu-id="03390-114">When the application calls `Close` on the connection, the pooler returns it to the pooled set of active connections instead of closing it.</span></span> <span data-ttu-id="03390-115">Una vez que la conexión vuelve al grupo, ya está preparada para volverse a utilizar en la siguiente llamada a `Open`.</span><span class="sxs-lookup"><span data-stu-id="03390-115">Once the connection is returned to the pool, it is ready to be reused on the next `Open` call.</span></span>  
  
 <span data-ttu-id="03390-116">Solo se pueden agrupar conexiones con la misma configuración.</span><span class="sxs-lookup"><span data-stu-id="03390-116">Only connections with the same configuration can be pooled.</span></span> <span data-ttu-id="03390-117">ADO.NET mantiene varios grupos al mismo tiempo, uno para cada configuración.</span><span class="sxs-lookup"><span data-stu-id="03390-117">ADO.NET keeps several pools at the same time, one for each configuration.</span></span> <span data-ttu-id="03390-118">Las conexiones se dividen en grupos por cadena de conexión, y por identidad de Windows si se utiliza seguridad integrada.</span><span class="sxs-lookup"><span data-stu-id="03390-118">Connections are separated into pools by connection string, and by Windows identity when integrated security is used.</span></span> <span data-ttu-id="03390-119">Las conexiones también se agrupan en función de si están incluidas en una transacción.</span><span class="sxs-lookup"><span data-stu-id="03390-119">Connections are also pooled based on whether they are enlisted in a transaction.</span></span> <span data-ttu-id="03390-120">Cuando se usa <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, la instancia de <xref:System.Data.SqlClient.SqlCredential> afecta al grupo de conexiones.</span><span class="sxs-lookup"><span data-stu-id="03390-120">When using <xref:System.Data.SqlClient.SqlConnection.ChangePassword%2A>, the <xref:System.Data.SqlClient.SqlCredential> instance affects the connection pool.</span></span> <span data-ttu-id="03390-121">Distintas instancias de <xref:System.Data.SqlClient.SqlCredential> usarán diferentes grupos de conexiones, incluso si el identificador de usuario y la contraseña son iguales.</span><span class="sxs-lookup"><span data-stu-id="03390-121">Different instances of <xref:System.Data.SqlClient.SqlCredential> will use different connection pools, even if the user ID and password are the same.</span></span>  
  
 <span data-ttu-id="03390-122">La agrupación de conexiones puede mejorar de forma considerable el rendimiento y la escalabilidad de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="03390-122">Pooling connections can significantly enhance the performance and scalability of your application.</span></span> <span data-ttu-id="03390-123">De forma predeterminada, la agrupación de conexiones está habilitada en ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="03390-123">By default, connection pooling is enabled in ADO.NET.</span></span> <span data-ttu-id="03390-124">A menos que la deshabilite explícitamente, el agrupador optimiza las conexiones a medida que se abren y cierran en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="03390-124">Unless you explicitly disable it, the pooler optimizes the connections as they are opened and closed in your application.</span></span> <span data-ttu-id="03390-125">También puede proporcionar varios modificadores de cadena de conexión para controlar el comportamiento de agrupación de conexiones.</span><span class="sxs-lookup"><span data-stu-id="03390-125">You can also supply several connection string modifiers to control connection pooling behavior.</span></span> <span data-ttu-id="03390-126">Para obtener más información, vea "Control de la agrupación de conexiones con palabras clave de cadena de conexión" más adelante en este tema.</span><span class="sxs-lookup"><span data-stu-id="03390-126">For more information, see "Controlling Connection Pooling with Connection String Keywords" later in this topic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="03390-127">Cuando se habilita la agrupación de conexiones, y si se produce un error de tiempo de expiración u otro error de inicio de sesión, se producirá una excepción y los intentos de conexión posteriores producirán errores durante los cinco segundos siguientes, el "período de bloqueo".</span><span class="sxs-lookup"><span data-stu-id="03390-127">When connection pooling is enabled, and if a timeout error or other login error occurs, an exception will be thrown and subsequent connection attempts will fail for the next five seconds, the "blocking period".</span></span> <span data-ttu-id="03390-128">Si la aplicación intenta conectarse dentro del período de bloqueo, se volverá a producir la primera excepción.</span><span class="sxs-lookup"><span data-stu-id="03390-128">If the application attempts to connect within the blocking period, the first exception will be thrown again.</span></span> <span data-ttu-id="03390-129">Los errores que se produzcan después de que finalice un período de bloqueo darán lugar a nuevos períodos de bloqueo que serán el doble de largos que el período de bloqueo anterior, hasta un máximo de un minuto.</span><span class="sxs-lookup"><span data-stu-id="03390-129">Subsequent failures after a blocking period ends will result in a new blocking periods that is twice as long as the previous blocking period, up to a maximum of one minute.</span></span>  
  
## <a name="pool-creation-and-assignment"></a><span data-ttu-id="03390-130">Creación y asignación del grupo</span><span class="sxs-lookup"><span data-stu-id="03390-130">Pool Creation and Assignment</span></span>  

 <span data-ttu-id="03390-131">Cuando se abre una conexión por primera vez, se crea un grupo de conexión basado en un algoritmo de coincidencia exacta que asocia el grupo con la cadena de conexión de la conexión.</span><span class="sxs-lookup"><span data-stu-id="03390-131">When a connection is first opened, a connection pool is created based on an exact matching algorithm that associates the pool with the connection string in the connection.</span></span> <span data-ttu-id="03390-132">Cada grupo de conexión se asocia con una cadena de conexión distinta.</span><span class="sxs-lookup"><span data-stu-id="03390-132">Each connection pool is associated with a distinct connection string.</span></span> <span data-ttu-id="03390-133">Si se abre una nueva conexión y la cadena de conexión no coincide exactamente con un grupo existente, se crea un nuevo grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-133">When a new connection is opened, if the connection string is not an exact match to an existing pool, a new pool is created.</span></span> <span data-ttu-id="03390-134">Las conexiones se agrupan por proceso, por dominio de aplicación, por cadena de conexión y, cuando se utiliza seguridad integrada, por identidad de Windows.</span><span class="sxs-lookup"><span data-stu-id="03390-134">Connections are pooled per process, per application domain, per connection string and when integrated security is used, per Windows identity.</span></span> <span data-ttu-id="03390-135">Las cadenas de conexión también deben ser una coincidencia exacta; las palabras clave indicadas en un orden diferente para la misma conexión se agruparán por separado.</span><span class="sxs-lookup"><span data-stu-id="03390-135">Connection strings must also be an exact match; keywords supplied in a different order for the same connection will be pooled separately.</span></span>  
  
 <span data-ttu-id="03390-136">En el siguiente ejemplo con C#, se crean tres nuevos objetos <xref:System.Data.SqlClient.SqlConnection>, pero solo se necesitan dos grupos de conexión para administrarlos.</span><span class="sxs-lookup"><span data-stu-id="03390-136">In the following C# example, three new <xref:System.Data.SqlClient.SqlConnection> objects are created, but only two connection pools are required to manage them.</span></span> <span data-ttu-id="03390-137">Observe que las cadenas de conexión primera y segunda difieren en el valor asignado a `Initial Catalog`.</span><span class="sxs-lookup"><span data-stu-id="03390-137">Note that the first and second connection strings differ by the value assigned for `Initial Catalog`.</span></span>  
  
```csharp
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // Pool A is created.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=pubs"))  
    {  
        connection.Open();
        // Pool B is created because the connection strings differ.  
    }  
  
using (SqlConnection connection = new SqlConnection(  
  "Integrated Security=SSPI;Initial Catalog=Northwind"))  
    {  
        connection.Open();
        // The connection string matches pool A.  
    }  
```  
  
 <span data-ttu-id="03390-138">Si no se especifica `MinPoolSize` en la cadena de conexión o se especifica como cero, las conexiones del grupo se cerrarán tras un período de inactividad.</span><span class="sxs-lookup"><span data-stu-id="03390-138">If `MinPoolSize` is either not specified in the connection string or is specified as zero, the connections in the pool will be closed after a period of inactivity.</span></span> <span data-ttu-id="03390-139">No obstante, si el `MinPoolSize` especificado es mayor que cero, el grupo de conexión no se destruye hasta que se descarga el `AppDomain` y finaliza el proceso.</span><span class="sxs-lookup"><span data-stu-id="03390-139">However, if the specified `MinPoolSize` is greater than zero, the connection pool is not destroyed until the `AppDomain` is unloaded and the process ends.</span></span> <span data-ttu-id="03390-140">El mantenimiento de grupos inactivos o vacíos supone una sobrecarga mínima para el sistema.</span><span class="sxs-lookup"><span data-stu-id="03390-140">Maintenance of inactive or empty pools involves minimal system overhead.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="03390-141">El grupo se borra automáticamente cuando se produce un error irrecuperable, como una conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="03390-141">The pool is automatically cleared when a fatal error occurs, such as a failover.</span></span>  
  
## <a name="adding-connections"></a><span data-ttu-id="03390-142">Agregar conexiones</span><span class="sxs-lookup"><span data-stu-id="03390-142">Adding Connections</span></span>  

 <span data-ttu-id="03390-143">Para cada cadena de conexión única se crea un grupo de conexión.</span><span class="sxs-lookup"><span data-stu-id="03390-143">A connection pool is created for each unique connection string.</span></span> <span data-ttu-id="03390-144">Cuando se crea un grupo, se crean y agregan al grupo varios objetos de conexión y se satisface así el requisito de tamaño mínimo del grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-144">When a pool is created, multiple connection objects are created and added to the pool so that the minimum pool size requirement is satisfied.</span></span> <span data-ttu-id="03390-145">Las conexiones se agregan al grupo cuando es necesario, hasta el tamaño máximo del grupo especificado (100 es el valor predeterminado),</span><span class="sxs-lookup"><span data-stu-id="03390-145">Connections are added to the pool as needed, up to the maximum pool size specified (100 is the default).</span></span> <span data-ttu-id="03390-146">y se liberan de nuevo en el grupo cuando se cierran o eliminan.</span><span class="sxs-lookup"><span data-stu-id="03390-146">Connections are released back into the pool when they are closed or disposed.</span></span>  
  
 <span data-ttu-id="03390-147">Cuando se solicita un objeto <xref:System.Data.SqlClient.SqlConnection>, se obtiene del grupo si se encuentra disponible una conexión que se pueda utilizar.</span><span class="sxs-lookup"><span data-stu-id="03390-147">When a <xref:System.Data.SqlClient.SqlConnection> object is requested, it is obtained from the pool if a usable connection is available.</span></span> <span data-ttu-id="03390-148">Una conexión de este tipo debe estar sin utilizar, tener un contexto de transacción coincidente o no estar asociada con ningún contexto de transacción y tener un vínculo válido al servidor.</span><span class="sxs-lookup"><span data-stu-id="03390-148">To be usable, a connection must be unused, have a matching transaction context or be unassociated with any transaction context, and have a valid link to the server.</span></span>  
  
 <span data-ttu-id="03390-149">El agrupador de conexiones satisface las solicitudes de conexión al reasignar las conexiones conforme se liberan de nuevo en el grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-149">The connection pooler satisfies requests for connections by reallocating connections as they are released back into the pool.</span></span> <span data-ttu-id="03390-150">Si se ha alcanzado el tamaño máximo del grupo y no hay disponible ninguna conexión que se pueda utilizar, la solicitud se pone en la cola.</span><span class="sxs-lookup"><span data-stu-id="03390-150">If the maximum pool size has been reached and no usable connection is available, the request is queued.</span></span> <span data-ttu-id="03390-151">A continuación, el concentrador intenta reclamar las conexiones hasta que se agota el tiempo de espera (el valor predeterminado es 15 segundos).</span><span class="sxs-lookup"><span data-stu-id="03390-151">The pooler then tries to reclaim any connections until the time-out is reached (the default is 15 seconds).</span></span> <span data-ttu-id="03390-152">Si no puede satisfacer la solicitud antes de que se agote el tiempo de espera de la conexión, se inicia una excepción.</span><span class="sxs-lookup"><span data-stu-id="03390-152">If the pooler cannot satisfy the request before the connection times out, an exception is thrown.</span></span>  
  
> [!CAUTION]
> <span data-ttu-id="03390-153">Se recomienda encarecidamente cerrar siempre la conexión cuando se termine de utilizar para que regrese al grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-153">We strongly recommend that you always close the connection when you are finished using it so that the connection will be returned to the pool.</span></span> <span data-ttu-id="03390-154">Para ello, puede usar los `Close` métodos o `Dispose` del `Connection` objeto o abrir todas las conexiones dentro de una `using` instrucción en C#, o una `Using` instrucción de Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="03390-154">You can do this using either the `Close` or `Dispose` methods of the `Connection` object, or by opening all connections inside a `using` statement in C#, or a `Using` statement in Visual Basic.</span></span> <span data-ttu-id="03390-155">Es posible que las conexiones que no se cierran explícitamente no se puedan agregar ni puedan regresar al grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-155">Connections that are not explicitly closed might not be added or returned to the pool.</span></span> <span data-ttu-id="03390-156">Para obtener más información, vea [using (instrucción](../../../csharp/language-reference/keywords/using-statement.md) ) o [Cómo: desechar un recurso del sistema](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) para Visual Basic.</span><span class="sxs-lookup"><span data-stu-id="03390-156">For more information, see [using Statement](../../../csharp/language-reference/keywords/using-statement.md) or [How to: Dispose of a System Resource](../../../visual-basic/programming-guide/language-features/control-flow/how-to-dispose-of-a-system-resource.md) for Visual Basic.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="03390-157">No llame a `Close` o a `Dispose` en un objeto `Connection`, un objeto `DataReader` o cualquier otro objeto administrado en el método `Finalize` de la clase.</span><span class="sxs-lookup"><span data-stu-id="03390-157">Do not call `Close` or `Dispose` on a `Connection`, a `DataReader`, or any other managed object in the `Finalize` method of your class.</span></span> <span data-ttu-id="03390-158">En un finalizador, libere solo los recursos no administrados que pertenezcan directamente a su clase.</span><span class="sxs-lookup"><span data-stu-id="03390-158">In a finalizer, only release unmanaged resources that your class owns directly.</span></span> <span data-ttu-id="03390-159">Si la clase no dispone de recursos no administrados, no incluya un método `Finalize` en la definición de clase.</span><span class="sxs-lookup"><span data-stu-id="03390-159">If your class does not own any unmanaged resources, do not include a `Finalize` method in your class definition.</span></span> <span data-ttu-id="03390-160">Para obtener más información, consulte recolección de [elementos no utilizados](../../../standard/garbage-collection/index.md).</span><span class="sxs-lookup"><span data-stu-id="03390-160">For more information, see [Garbage Collection](../../../standard/garbage-collection/index.md).</span></span>  
  
<span data-ttu-id="03390-161">Para obtener más información sobre los eventos asociados a la apertura y el cierre de conexiones, vea [Audit login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) y [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) en la documentación de SQL Server.</span><span class="sxs-lookup"><span data-stu-id="03390-161">For more info about the events associated with opening and closing connections, see [Audit Login Event Class](/sql/relational-databases/event-classes/audit-login-event-class) and [Audit Logout Event Class](/sql/relational-databases/event-classes/audit-logout-event-class) in the SQL Server documentation.</span></span>  
  
## <a name="removing-connections"></a><span data-ttu-id="03390-162">Cómo quitar conexiones</span><span class="sxs-lookup"><span data-stu-id="03390-162">Removing Connections</span></span>  

 <span data-ttu-id="03390-163">El agrupador de conexiones quita una conexión del grupo después de haber estado inactiva unos 4-8 minutos o si detecta que se ha roto la conexión con el servidor.</span><span class="sxs-lookup"><span data-stu-id="03390-163">The connection pooler removes a connection from the pool after it has been idle for approximately 4-8 minutes, or if the pooler detects that the connection with the server has been severed.</span></span> <span data-ttu-id="03390-164">Tenga en cuenta que una conexión rota solo puede detectarse después de intentar comunicarse con el servidor.</span><span class="sxs-lookup"><span data-stu-id="03390-164">Note that a severed connection can be detected only after attempting to communicate with the server.</span></span> <span data-ttu-id="03390-165">Si se encuentra que una conexión ya no está conectada al servidor, se marca como no válida.</span><span class="sxs-lookup"><span data-stu-id="03390-165">If a connection is found that is no longer connected to the server, it is marked as invalid.</span></span> <span data-ttu-id="03390-166">Las conexiones no válidas se quitan del grupo de conexión solo cuando se cierran o reclaman.</span><span class="sxs-lookup"><span data-stu-id="03390-166">Invalid connections are removed from the connection pool only when they are closed or reclaimed.</span></span>  
  
 <span data-ttu-id="03390-167">Si existe una conexión en un servidor que ha desaparecido, se puede extraer del grupo aunque el agrupador de conexiones no haya detectado la conexión rota y la haya marcado como no válida.</span><span class="sxs-lookup"><span data-stu-id="03390-167">If a connection exists to a server that has disappeared, this connection can be drawn from the pool even if the connection pooler has not detected the severed connection and marked it as invalid.</span></span> <span data-ttu-id="03390-168">El motivo es que la sobrecarga de comprobar que la conexión es aún válida eliminaría los beneficios de tener un concentrador y ocasionaría que se produjera otro viaje de ida y vuelta (round trip) al servidor.</span><span class="sxs-lookup"><span data-stu-id="03390-168">This is the case because the overhead of checking that the connection is still valid would eliminate the benefits of having a pooler by causing another round trip to the server to occur.</span></span> <span data-ttu-id="03390-169">Cuando esto ocurre, el primer intento para usar la conexión detectará que ésta se ha roto y se iniciará una excepción.</span><span class="sxs-lookup"><span data-stu-id="03390-169">When this occurs, the first attempt to use the connection will detect that the connection has been severed, and an exception is thrown.</span></span>  
  
## <a name="clearing-the-pool"></a><span data-ttu-id="03390-170">Borrado del grupo</span><span class="sxs-lookup"><span data-stu-id="03390-170">Clearing the Pool</span></span>  

 <span data-ttu-id="03390-171">ADO.NET 2,0 presentó dos nuevos métodos para borrar el Grupo: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> y <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A> .</span><span class="sxs-lookup"><span data-stu-id="03390-171">ADO.NET 2.0 introduced two new methods to clear the pool: <xref:System.Data.SqlClient.SqlConnection.ClearAllPools%2A> and <xref:System.Data.SqlClient.SqlConnection.ClearPool%2A>.</span></span> <span data-ttu-id="03390-172">`ClearAllPools` borra los grupos de conexión de un proveedor dado, y `ClearPool` borra el grupo de conexión que está asociado a una conexión concreta.</span><span class="sxs-lookup"><span data-stu-id="03390-172">`ClearAllPools` clears the connection pools for a given provider, and `ClearPool` clears the connection pool that is associated with a specific connection.</span></span> <span data-ttu-id="03390-173">Si en el momento de la llamada se están usando conexiones, se marcan de forma adecuada.</span><span class="sxs-lookup"><span data-stu-id="03390-173">If there are connections being used at the time of the call, they are marked appropriately.</span></span> <span data-ttu-id="03390-174">Cuando se cierran, se descartan en lugar de devolverse al grupo.</span><span class="sxs-lookup"><span data-stu-id="03390-174">When they are closed, they are discarded instead of being returned to the pool.</span></span>  
  
## <a name="transaction-support"></a><span data-ttu-id="03390-175">Compatibilidad con transacciones</span><span class="sxs-lookup"><span data-stu-id="03390-175">Transaction Support</span></span>  

 <span data-ttu-id="03390-176">Las conexiones se extraen del grupo y se asignan en función del contexto de transacción.</span><span class="sxs-lookup"><span data-stu-id="03390-176">Connections are drawn from the pool and assigned based on transaction context.</span></span> <span data-ttu-id="03390-177">A menos que se especifique `Enlist=false` en la cadena de conexión, el grupo de conexión garantiza que la conexión está dada de alta en el contexto de <xref:System.Transactions.Transaction.Current%2A>.</span><span class="sxs-lookup"><span data-stu-id="03390-177">Unless `Enlist=false` is specified in the connection string, the connection pool makes sure that the connection is enlisted in the <xref:System.Transactions.Transaction.Current%2A> context.</span></span> <span data-ttu-id="03390-178">Cuando se cierra una conexión y se devuelve al grupo con una transacción `System.Transactions` dada de alta, se reserva de forma que la siguiente solicitud de ese grupo de conexiones con la misma transacción `System.Transactions` devolverá la misma conexión, si está disponible.</span><span class="sxs-lookup"><span data-stu-id="03390-178">When a connection is closed and returned to the pool with an enlisted `System.Transactions` transaction, it is set aside in such a way that the next request for that connection pool with the same `System.Transactions` transaction will return the same connection if it is available.</span></span> <span data-ttu-id="03390-179">Si se emite dicha solicitud y no hay conexiones agrupadas disponibles, se extrae una conexión de la parte sin transacción del grupo y se le da de alta.</span><span class="sxs-lookup"><span data-stu-id="03390-179">If such a request is issued, and there are no pooled connections available, a connection is drawn from the non-transacted part of the pool and enlisted.</span></span> <span data-ttu-id="03390-180">Si no hay conexiones disponibles en cualquier área del grupo, se crea y da de alta una nueva conexión.</span><span class="sxs-lookup"><span data-stu-id="03390-180">If no connections are available in either area of the pool, a new connection is created and enlisted.</span></span>  
  
 <span data-ttu-id="03390-181">Cuando se cierra una conexión, se libera de nuevo en el grupo y en la subdivisión adecuada en función de su contexto de transacción.</span><span class="sxs-lookup"><span data-stu-id="03390-181">When a connection is closed, it is released back into the pool and into the appropriate subdivision based on its transaction context.</span></span> <span data-ttu-id="03390-182">Por lo tanto, puede cerrar la conexión sin generar un error, incluso aunque aún haya pendiente una transacción distribuida.</span><span class="sxs-lookup"><span data-stu-id="03390-182">Therefore, you can close the connection without generating an error, even though a distributed transaction is still pending.</span></span> <span data-ttu-id="03390-183">Esto permite confirmar o anular la transacción distribuida más adelante.</span><span class="sxs-lookup"><span data-stu-id="03390-183">This allows you to commit or abort the distributed transaction later.</span></span>  
  
## <a name="controlling-connection-pooling-with-connection-string-keywords"></a><span data-ttu-id="03390-184">Control de la agrupación de conexiones con palabras clave de cadena de conexión</span><span class="sxs-lookup"><span data-stu-id="03390-184">Controlling Connection Pooling with Connection String Keywords</span></span>  

 <span data-ttu-id="03390-185">La propiedad `ConnectionString` del objeto <xref:System.Data.SqlClient.SqlConnection> admite pares clave-valor de cadena de conexión que se pueden utilizar para ajustar el comportamiento de la lógica de agrupación de conexiones.</span><span class="sxs-lookup"><span data-stu-id="03390-185">The `ConnectionString` property of the <xref:System.Data.SqlClient.SqlConnection> object supports connection string key/value pairs that can be used to adjust the behavior of the connection pooling logic.</span></span> <span data-ttu-id="03390-186">Para obtener más información, vea <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span><span class="sxs-lookup"><span data-stu-id="03390-186">For more information, see <xref:System.Data.SqlClient.SqlConnection.ConnectionString%2A>.</span></span>  
  
## <a name="pool-fragmentation"></a><span data-ttu-id="03390-187">Fragmentación de grupos</span><span class="sxs-lookup"><span data-stu-id="03390-187">Pool Fragmentation</span></span>  

 <span data-ttu-id="03390-188">La fragmentación de grupos es un problema común en muchas aplicaciones web en las que la aplicación puede crear gran cantidad de grupos que no se liberan hasta que finaliza el proceso.</span><span class="sxs-lookup"><span data-stu-id="03390-188">Pool fragmentation is a common problem in many Web applications where the application can create a large number of pools that are not freed until the process exits.</span></span> <span data-ttu-id="03390-189">El resultado es un gran número de conexiones abiertas que consumen memoria, lo que da lugar a un bajo rendimiento.</span><span class="sxs-lookup"><span data-stu-id="03390-189">This leaves a large number of connections open and consuming memory, which results in poor performance.</span></span>  
  
### <a name="pool-fragmentation-due-to-integrated-security"></a><span data-ttu-id="03390-190">Fragmentación de grupos debido a la seguridad integrada</span><span class="sxs-lookup"><span data-stu-id="03390-190">Pool Fragmentation Due to Integrated Security</span></span>  

 <span data-ttu-id="03390-191">Las conexiones se agrupan de acuerdo con la cadena de conexión y la identidad del usuario.</span><span class="sxs-lookup"><span data-stu-id="03390-191">Connections are pooled according to the connection string plus the user identity.</span></span> <span data-ttu-id="03390-192">Por lo tanto, si utiliza autenticación básica o autenticación de Windows en el sitio web y un inicio de sesión de seguridad integrada, obtendrá un grupo por usuario.</span><span class="sxs-lookup"><span data-stu-id="03390-192">Therefore, if you use Basic authentication or Windows Authentication on the Web site and an integrated security login, you get one pool per user.</span></span> <span data-ttu-id="03390-193">Aunque de esta manera se mejora el rendimiento de las posteriores solicitudes de base de datos de un solo usuario, ese usuario no podrá aprovechar las conexiones realizadas por otros usuarios.</span><span class="sxs-lookup"><span data-stu-id="03390-193">Although this improves the performance of subsequent database requests for a single user, that user cannot take advantage of connections made by other users.</span></span> <span data-ttu-id="03390-194">Además, como resultado habrá una conexión como mínimo por usuario al servidor de bases de datos.</span><span class="sxs-lookup"><span data-stu-id="03390-194">It also results in at least one connection per user to the database server.</span></span> <span data-ttu-id="03390-195">Se trata de un efecto secundario de una determinada arquitectura de aplicaciones web que los desarrolladores deben sopesar frente a los requisitos de seguridad y auditoría.</span><span class="sxs-lookup"><span data-stu-id="03390-195">This is a side effect of a particular Web application architecture that developers must weigh against security and auditing requirements.</span></span>  
  
### <a name="pool-fragmentation-due-to-many-databases"></a><span data-ttu-id="03390-196">Fragmentación de grupos debido a muchas bases de datos</span><span class="sxs-lookup"><span data-stu-id="03390-196">Pool Fragmentation Due to Many Databases</span></span>  

 <span data-ttu-id="03390-197">Muchos proveedores de acceso a Internet hospedan varios sitios web en un único servidor.</span><span class="sxs-lookup"><span data-stu-id="03390-197">Many Internet service providers host several Web sites on a single server.</span></span> <span data-ttu-id="03390-198">Puede que utilicen una sola base de datos para confirmar un inicio de sesión de autenticación de formularios y luego abran una conexión a una base de datos específica para ese usuario o grupo de usuarios.</span><span class="sxs-lookup"><span data-stu-id="03390-198">They may use a single database to confirm a Forms authentication login and then open a connection to a specific database for that user or group of users.</span></span> <span data-ttu-id="03390-199">La conexión a la base de datos de autenticación es agrupada y utilizada por todo el mundo.</span><span class="sxs-lookup"><span data-stu-id="03390-199">The connection to the authentication database is pooled and used by everyone.</span></span> <span data-ttu-id="03390-200">Sin embargo, hay un grupo independiente de conexiones con cada base de datos, lo que implica un aumento del número de conexiones con el servidor.</span><span class="sxs-lookup"><span data-stu-id="03390-200">However, there is a separate pool of connections to each database, which increase the number of connections to the server.</span></span>  
  
 <span data-ttu-id="03390-201">Este es también un efecto secundario del diseño de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="03390-201">This is also a side-effect of the application design.</span></span> <span data-ttu-id="03390-202">Existe, sin embargo, una forma relativamente sencilla de evitarlo sin comprometer la seguridad cuando se establece conexión con SQL Server.</span><span class="sxs-lookup"><span data-stu-id="03390-202">There is a relatively simple way to avoid this side effect without compromising security when you connect to SQL Server.</span></span> <span data-ttu-id="03390-203">En lugar de realizar una conexión a una base de datos diferente por cada usuario o grupo, realice una conexión a la misma base de datos en el servidor y, a continuación, ejecute la instrucción USE de Transact-SQL para cambiar a la base de datos deseada.</span><span class="sxs-lookup"><span data-stu-id="03390-203">Instead of connecting to a separate database for each user or group, connect to the same database on the server and then execute the Transact-SQL USE statement to change to the desired database.</span></span> <span data-ttu-id="03390-204">En el siguiente fragmento de código se muestra la creación de una conexión inicial con la base de datos `master` y el cambio a la base de datos deseada especificada en la variable de cadena `databaseName`.</span><span class="sxs-lookup"><span data-stu-id="03390-204">The following code fragment demonstrates creating an initial connection to the `master` database and then switching to the desired database specified in the `databaseName` string variable.</span></span>  
  
```vb  
' Assumes that command is a valid SqlCommand object and that  
' connectionString connects to master.  
    command.Text = "USE DatabaseName"  
Using connection As New SqlConnection(connectionString)  
    connection.Open()  
    command.ExecuteNonQuery()  
End Using  
```  
  
```csharp  
// Assumes that command is a SqlCommand object and that  
// connectionString connects to master.  
command.Text = "USE DatabaseName";  
using (SqlConnection connection = new SqlConnection(  
  connectionString))  
  {  
    connection.Open();  
    command.ExecuteNonQuery();  
  }  
```  
  
## <a name="application-roles-and-connection-pooling"></a><span data-ttu-id="03390-205">Roles de aplicación y agrupación de conexiones</span><span class="sxs-lookup"><span data-stu-id="03390-205">Application Roles and Connection Pooling</span></span>  

 <span data-ttu-id="03390-206">Una vez activada una función de aplicación de SQL Server al llamar al procedimiento almacenado de sistema `sp_setapprole`, no se puede restablecer el contexto de seguridad de la conexión.</span><span class="sxs-lookup"><span data-stu-id="03390-206">After a SQL Server application role has been activated by calling the `sp_setapprole` system stored procedure, the security context of that connection cannot be reset.</span></span> <span data-ttu-id="03390-207">Sin embargo, cuando se habilita la agrupación, la conexión se devuelve al grupo y se produce un error al utilizar de nuevo la conexión agrupada.</span><span class="sxs-lookup"><span data-stu-id="03390-207">However, if pooling is enabled, the connection is returned to the pool, and an error occurs when the pooled connection is reused.</span></span> <span data-ttu-id="03390-208">Para obtener más información, vea el artículo de Knowledge base "[errores de rol de aplicación SQL con agrupación de recursos de OLE DB](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)".</span><span class="sxs-lookup"><span data-stu-id="03390-208">For more information, see the Knowledge Base article, "[SQL application role errors with OLE DB resource pooling](https://support.microsoft.com/default.aspx?scid=KB;EN-US;Q229564)."</span></span>  
  
### <a name="application-role-alternatives"></a><span data-ttu-id="03390-209">Alternativas a los roles de aplicación</span><span class="sxs-lookup"><span data-stu-id="03390-209">Application Role Alternatives</span></span>  

 <span data-ttu-id="03390-210">Se recomienda aprovechar las ventajas de los mecanismos de seguridad que se pueden usar en lugar de roles de aplicación.</span><span class="sxs-lookup"><span data-stu-id="03390-210">We recommend that you take advantage of security mechanisms that you can use instead of application roles.</span></span> <span data-ttu-id="03390-211">Para obtener más información, vea [crear roles de aplicación en SQL Server](./sql/creating-application-roles-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="03390-211">For more information, see [Creating Application Roles in SQL Server](./sql/creating-application-roles-in-sql-server.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="03390-212">Vea también</span><span class="sxs-lookup"><span data-stu-id="03390-212">See also</span></span>

- [<span data-ttu-id="03390-213">Agrupar conexiones</span><span class="sxs-lookup"><span data-stu-id="03390-213">Connection Pooling</span></span>](connection-pooling.md)
- [<span data-ttu-id="03390-214">SQL Server y ADO.NET</span><span class="sxs-lookup"><span data-stu-id="03390-214">SQL Server and ADO.NET</span></span>](./sql/index.md)
- [<span data-ttu-id="03390-215">Contadores de rendimiento</span><span class="sxs-lookup"><span data-stu-id="03390-215">Performance Counters</span></span>](performance-counters.md)
- [<span data-ttu-id="03390-216">Información general de ADO.NET</span><span class="sxs-lookup"><span data-stu-id="03390-216">ADO.NET Overview</span></span>](ado-net-overview.md)
