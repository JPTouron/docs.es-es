---
title: Optimización mediante el uso de la confirmación de fase única y de la inscripción de fase única promovible
description: Optimice el rendimiento mediante la confirmación de fase única y la notificación de fase única promocionable. Obtenga información sobre la infraestructura de System. Transactions en .NET.
ms.date: 03/30/2017
ms.assetid: 57beaf1a-fb4d-441a-ab1d-bc0c14ce7899
ms.openlocfilehash: 89ce82e673340c93254983c078f78a2501129383
ms.sourcegitcommit: 6219b1e1feccb16d88656444210fed3297f5611e
ms.translationtype: MT
ms.contentlocale: es-ES
ms.lasthandoff: 06/22/2020
ms.locfileid: "85141983"
---
# <a name="optimization-using-single-phase-commit-and-promotable-single-phase-notification"></a><span data-ttu-id="6069d-104">Optimización mediante el uso de la confirmación de fase única y de la inscripción de fase única promovible</span><span class="sxs-lookup"><span data-stu-id="6069d-104">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>

<span data-ttu-id="6069d-105">En este tema se describen los mecanismos proporcionados por la infraestructura <xref:System.Transactions> para optimizar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="6069d-105">This topic describes the mechanisms provided by the <xref:System.Transactions> infrastructure to optimize performance.</span></span>

## <a name="promotable-single-phase-enlistment"></a><span data-ttu-id="6069d-106">Inscripción de la fase única promocionable</span><span class="sxs-lookup"><span data-stu-id="6069d-106">Promotable Single Phase Enlistment</span></span>

<span data-ttu-id="6069d-107">La infraestructura <xref:System.Transactions> administra una transacción dentro de un dominio de aplicación único que implica a lo sumo un recurso durable único o varios recursos volátiles.</span><span class="sxs-lookup"><span data-stu-id="6069d-107">The <xref:System.Transactions> infrastructure administrates a transaction inside a single application domain that involves at most a single durable resource or multiple volatile resources.</span></span> <span data-ttu-id="6069d-108">Puesto que la infraestructura <xref:System.Transactions> solo utiliza las llamadas de dominio de intraaplicación, produce el mejor rendimiento.</span><span class="sxs-lookup"><span data-stu-id="6069d-108">Since the <xref:System.Transactions> infrastructure uses only intra-application domain calls, it yields the best throughput and performance.</span></span>

<span data-ttu-id="6069d-109">Sin embargo, si la transacción se proporciona a otro objeto en otro dominio de aplicación (incluso por el proceso y límites del equipo) en el mismo equipo, o si fuera dar de alta otro administrador de recursos duradero, la infraestructura <xref:System.Transactions> realiza automáticamente una escalada de la transacción que va a ser administrada por MSDTC.</span><span class="sxs-lookup"><span data-stu-id="6069d-109">However, if the transaction is provided to another object in another application domain (including across process and machine boundaries) on the same computer, or if you were to enlist another durable resource manager, the <xref:System.Transactions> infrastructure automatically escalates the transaction to be managed by the MSDTC.</span></span> <span data-ttu-id="6069d-110">Una transacción administrada por MSDTC no rinde tan eficazmente como uno administrado por la infraestructura <xref:System.Transactions>.</span><span class="sxs-lookup"><span data-stu-id="6069d-110">A transaction managed by MSDTC is not as performance-wise as one managed by the <xref:System.Transactions> infrastructure.</span></span>

<span data-ttu-id="6069d-111">Para optimizar el rendimiento, la infraestructura <xref:System.Transactions> proporciona la Inscripción (PSPE) de Fase de Soltero promocionable que permite un recurso duradero remoto único, situado en un dominio de aplicación diferente, proceso o equipo, para participar en una transacción <xref:System.Transactions> sin producir una escalada a una transacción de MSDTC.</span><span class="sxs-lookup"><span data-stu-id="6069d-111">To optimize performance, the <xref:System.Transactions> infrastructure provides the Promotable Single Phase Enlistment (PSPE) that allows a single remote durable resource, located in a different application domain, process or machine, to participate in a <xref:System.Transactions> transaction without causing it to be escalated to an MSDTC transaction.</span></span> <span data-ttu-id="6069d-112">Este administrador de recursos (RM) puede hospedar y "poseer" una transacción que puede realizar una escalada después de una transacción distribuida (o transacción de MSDTC) si es necesario.</span><span class="sxs-lookup"><span data-stu-id="6069d-112">This resource manager (RM) can host and "own" a transaction that can later be escalated to a distributed transaction (or MSDTC transaction) if necessary.</span></span> <span data-ttu-id="6069d-113">Esto reduce aún más la oportunidad de utilizar MSDTC.</span><span class="sxs-lookup"><span data-stu-id="6069d-113">This reduces the chance of using the MSDTC.</span></span>

<span data-ttu-id="6069d-114">Este administrador de recursos concreto normalmente tiene sus propias transacciones no-distribuidas internas y necesita permitir convertir esas transacciones en las transacciones distribuidas en el tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="6069d-114">This specific resource manager usually has its own internal non distributed transactions and it needs to support converting those transactions to distributed transactions at runtime.</span></span> <span data-ttu-id="6069d-115">Por ejemplo, SQL Server 2005 es este tipo de administrador de recursos.</span><span class="sxs-lookup"><span data-stu-id="6069d-115">For example, SQL Server 2005 is such a resource manager.</span></span> <span data-ttu-id="6069d-116">En tal caso, la infraestructura <xref:System.Transactions> toma un rol de administración pasiva simplemente supervisando la transacción para una necesidad de subida.</span><span class="sxs-lookup"><span data-stu-id="6069d-116">In such case, the <xref:System.Transactions> infrastructure takes a passive management role by just monitoring the transaction for a need for escalation.</span></span> <span data-ttu-id="6069d-117">Para admitir la interacción entre la infraestructura <xref:System.Transactions> y el administrador de recursos, este último necesita implementar la interfaz <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span><span class="sxs-lookup"><span data-stu-id="6069d-117">To support the interaction between the <xref:System.Transactions> infrastructure and resource manager, the latter needs to implement the interface <xref:System.Transactions.IPromotableSinglePhaseNotification>.</span></span>

<span data-ttu-id="6069d-118">El método <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> se utiliza para dar de alta un recurso duradero único que pueda realizar después una escalada.</span><span class="sxs-lookup"><span data-stu-id="6069d-118">The <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method is used to enlist a single durable resource that can be escalated later.</span></span> <span data-ttu-id="6069d-119">Este método asegurar que la inscripción puede realizar una escalada según sea necesario.</span><span class="sxs-lookup"><span data-stu-id="6069d-119">This method ensures that the enlistment can be escalated as needed.</span></span> <span data-ttu-id="6069d-120">Si la inscripción tiene éxito, RM crea su transacción interna y la asocia a la transacción <xref:System.Transactions>.</span><span class="sxs-lookup"><span data-stu-id="6069d-120">If the enlistment succeeds, the RM creates its internal transaction and associates it with the <xref:System.Transactions> transaction.</span></span> <span data-ttu-id="6069d-121">En caso de error en la inscripción de PSPE, RM debería darse de alta utilizando en su lugar el método <xref:System.Transactions.Transaction.EnlistDurable%2A>.</span><span class="sxs-lookup"><span data-stu-id="6069d-121">If the PSPE enlistment fails, the RM should instead enlist using the <xref:System.Transactions.Transaction.EnlistDurable%2A> method.</span></span> <span data-ttu-id="6069d-122">Los errores para dar de alta en PSPE podrían ocurrir cuando la transacción ya es una transacción distribuida, o cuando RM ya ha realizado una inscripción de PSPE</span><span class="sxs-lookup"><span data-stu-id="6069d-122">Failures to enlist in PSPE might happen when the transaction is already a distributed transaction, or when another RM has already performed a PSPE enlistment</span></span>

<span data-ttu-id="6069d-123">Cuando esté dada de alta, las llamadas por clientes para confirmar o anular la transacción <xref:System.Transactions> se convierten en las llamadas en el Recurso Administrador invocando el método <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> o <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectivamente.</span><span class="sxs-lookup"><span data-stu-id="6069d-123">Once enlisted, calls by clients to commit or abort the <xref:System.Transactions> transaction are converted to calls on the Resource Manager by invoking the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> method, or the <xref:System.Transactions.IPromotableSinglePhaseNotification.Rollback%2A> respectively.</span></span>

<span data-ttu-id="6069d-124">Si la transacción <xref:System.Transactions> nunca requiere la subida, cuando se confirma la transacción, RM recibe una notificación <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A>.</span><span class="sxs-lookup"><span data-stu-id="6069d-124">If the <xref:System.Transactions> transaction never requires escalation, when the transaction is committed, the RM receives a <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification.</span></span> <span data-ttu-id="6069d-125">Puede confirmar a continuación la transacción interna que se creó inicialmente.</span><span class="sxs-lookup"><span data-stu-id="6069d-125">It can then commit the internal transaction that was initially created.</span></span>

<span data-ttu-id="6069d-126">Si la transacción <xref:System.Transactions> necesita realizar una escalada (por ejemplo, admitir varios RMs), <xref:System.Transactions> informa al administrador de recursos llamando al método <xref:System.Transactions.ITransactionPromoter.Promote%2A> en la interfaz <xref:System.Transactions.ITransactionPromoter>, de la que la interfaz <xref:System.Transactions.IPromotableSinglePhaseNotification> deriva.</span><span class="sxs-lookup"><span data-stu-id="6069d-126">If the <xref:System.Transactions> transaction needs to be escalated (e.g., to support multiple RMs), <xref:System.Transactions> informs the resource manager by calling the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface, from which the <xref:System.Transactions.IPromotableSinglePhaseNotification> interface derives.</span></span> <span data-ttu-id="6069d-127">El administrador de recursos convierte a continuación internamente la transacción de una transacción local (qué no requiere el registro) en un objeto de transacción que es capaz de participar en una transacción de DTC y lo asocia al trabajo ya hecho.</span><span class="sxs-lookup"><span data-stu-id="6069d-127">The resource manager then converts the transaction internally from a local transaction (which does not require logging) to a transaction object that is capable of participating in a DTC transaction, and associates it with the work already done.</span></span> <span data-ttu-id="6069d-128">Cuando solicitan que la transacción se confirme, el administrador de transacciones todavía envía la notificación <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> al administrador de recursos, que confirma la transacción distribuida que creó durante la subida.</span><span class="sxs-lookup"><span data-stu-id="6069d-128">When the transaction is asked to commit, the transaction manager still sends the <xref:System.Transactions.IPromotableSinglePhaseNotification.SinglePhaseCommit%2A> notification to the resource manager, which commits the distributed transaction that it created during escalation.</span></span>

> [!NOTE]
> <span data-ttu-id="6069d-129">Los seguimientos de **TransactionCommitted** (que se generan cuando se invoca una confirmación en la transacción escalada) contienen el ID. de actividad de la transacción DTC.</span><span class="sxs-lookup"><span data-stu-id="6069d-129">The **TransactionCommitted** traces (that are generated when a Commit is invoked on the escalated transaction) contain the activity ID of the DTC transaction.</span></span>

<span data-ttu-id="6069d-130">Para obtener más información sobre la extensión de administración, consulte [escalado de administración de transacciones](transaction-management-escalation.md).</span><span class="sxs-lookup"><span data-stu-id="6069d-130">For more information on management escalation, see [Transaction Management Escalation](transaction-management-escalation.md).</span></span>

## <a name="transaction-management-escalation-scenario"></a><span data-ttu-id="6069d-131">Escenario de subida de administración de la transacción</span><span class="sxs-lookup"><span data-stu-id="6069d-131">Transaction Management Escalation Scenario</span></span>

<span data-ttu-id="6069d-132">El escenario siguiente muestra una subida a una transacción distribuida utilizando el espacio de nombres <xref:System.Data> como el 'proxy' para el administrador de recursos.</span><span class="sxs-lookup"><span data-stu-id="6069d-132">The following scenario demonstrates an escalation to a distributed transaction using the <xref:System.Data> namespace as the ‘proxy’ for the resource manager.</span></span> <span data-ttu-id="6069d-133">Este escenario supone que es ya una conexión <xref:System.Data> a la base de datos, CN1, envuelto en la transacción y la aplicación desea implicar otra conexión <xref:System.Data>, CN2.</span><span class="sxs-lookup"><span data-stu-id="6069d-133">This scenario assumes that there is already one <xref:System.Data> connection to the database, CN1, involved in the transaction, and the application wants to involve another <xref:System.Data> connection, CN2.</span></span> <span data-ttu-id="6069d-134">La transacción debe realizar una escalada a DTC, como una transacción completa de la confirmación distribuida en dos fases.</span><span class="sxs-lookup"><span data-stu-id="6069d-134">The transaction must be escalated to DTC, as a full distributed two-phase commit transaction.</span></span>

<span data-ttu-id="6069d-135">En este escenario</span><span class="sxs-lookup"><span data-stu-id="6069d-135">In this scenario,</span></span>

1. <span data-ttu-id="6069d-136">CN1 llama al método <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> para dar de alta en la transacción.</span><span class="sxs-lookup"><span data-stu-id="6069d-136">CN1 calls the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist in the transaction.</span></span> <span data-ttu-id="6069d-137">A continuación, la transacción es todavía local y no es ningún otro alistamiento promocional en la transacción, por lo que la llamada <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> tiene éxito.</span><span class="sxs-lookup"><span data-stu-id="6069d-137">Then, the transaction is still local and there are no other promotable enlistments on the transaction, so the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> call succeeds.</span></span>

2. <span data-ttu-id="6069d-138">Cuando la segunda conexión, CN2 llama <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, se da un error en la llamada,  porque hay implicada otra inscripción promocional.</span><span class="sxs-lookup"><span data-stu-id="6069d-138">When the second connection, CN2 calls <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A>, the call fails because there is another promotable enlistment involved.</span></span> <span data-ttu-id="6069d-139">Debido a esto, CN2 debe obtener una transacción de DTC para pasarlo a SQL.</span><span class="sxs-lookup"><span data-stu-id="6069d-139">Because of this, CN2 must get a DTC transaction in order to pass it to SQL.</span></span> <span data-ttu-id="6069d-140">Utiliza uno de los métodos proporcionado por la clase <xref:System.Transactions.TransactionInterop> para generar un formato de la transacción que se puede dar a SQL para ello.</span><span class="sxs-lookup"><span data-stu-id="6069d-140">To do this, it uses one of the methods provided by the <xref:System.Transactions.TransactionInterop> class to produce a format of the transaction that can be given to SQL.</span></span>

3. <span data-ttu-id="6069d-141"><xref:System.Transactions> llama al método <xref:System.Transactions.ITransactionPromoter.Promote%2A> en la interfaz <xref:System.Transactions.ITransactionPromoter> implementada por CN1.</span><span class="sxs-lookup"><span data-stu-id="6069d-141"><xref:System.Transactions> calls the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method on the <xref:System.Transactions.ITransactionPromoter> interface implemented by CN1.</span></span>

4. <span data-ttu-id="6069d-142">En este punto, CN1 realiza una escalada de la transacción, utilizando algún mecanismo concreto a SQL 2005 y <xref:System.Data>.</span><span class="sxs-lookup"><span data-stu-id="6069d-142">At this point, CN1 escalates the transaction, using some mechanism specific to SQL 2005 and <xref:System.Data>.</span></span>

5. <span data-ttu-id="6069d-143">El valor devuelto del método <xref:System.Transactions.ITransactionPromoter.Promote%2A> es una matriz de bytes que contiene un token de propagación para la transacción.</span><span class="sxs-lookup"><span data-stu-id="6069d-143">The return value from the <xref:System.Transactions.ITransactionPromoter.Promote%2A> method is a byte array that contains a propagation token for the transaction.</span></span> <span data-ttu-id="6069d-144"><xref:System.Transactions>utiliza este token de propagación para crear una transacción de DTC que puede incorporar a la transacción local.</span><span class="sxs-lookup"><span data-stu-id="6069d-144"><xref:System.Transactions> uses this propagation token to create a DTC transaction that it can incorporate into the local transaction.</span></span>

6. <span data-ttu-id="6069d-145">En este punto, CN2 puede utilizar los datos recibidos de llamar a uno de los métodos por <xref:System.Transactions.TransactionInterop> para pasar la transacción a SQL.</span><span class="sxs-lookup"><span data-stu-id="6069d-145">At this point, CN2 can use the data received from calling one of the methods by <xref:System.Transactions.TransactionInterop> to pass the transaction to SQL.</span></span>

7. <span data-ttu-id="6069d-146">Ahora, ambos se dan de alta en una transacción distribuida de DTC.</span><span class="sxs-lookup"><span data-stu-id="6069d-146">Now, both are enlisted in a DTC distributed transaction.</span></span>

## <a name="single-phase-commit-optimization"></a><span data-ttu-id="6069d-147">Optimización de confirmación de fase única</span><span class="sxs-lookup"><span data-stu-id="6069d-147">Single Phase Commit Optimization</span></span>

<span data-ttu-id="6069d-148">La fase única el protocolo de confirmación es más eficaz en el tiempo de ejecución cuando todas las actualizaciones se hacen sin ninguna coordinación explícita.</span><span class="sxs-lookup"><span data-stu-id="6069d-148">The Single Phase Commit protocol is more efficient at runtime as all updates are done without any explicit coordination.</span></span> <span data-ttu-id="6069d-149">Para aprovecharse de esta optimización, debería implementar un administrador de recursos utilizando la interfaz <xref:System.Transactions.ISinglePhaseNotification> para el recurso y dar de alta en una transacción utilizando <xref:System.Transactions.Transaction.EnlistDurable%2A> o el método <xref:System.Transactions.Transaction.EnlistVolatile%2A>.</span><span class="sxs-lookup"><span data-stu-id="6069d-149">To take advantage of this optimization, you should implement a resource manager using <xref:System.Transactions.ISinglePhaseNotification> interface for the resource and enlist in a transaction using the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method.</span></span> <span data-ttu-id="6069d-150">En concreto, el parámetro *EnlistmentOptions* debe ser igual a <xref:System.Transactions.EnlistmentOptions.None> para asegurarse de que se realizará una confirmación de fase única.</span><span class="sxs-lookup"><span data-stu-id="6069d-150">Specifically, the *EnlistmentOptions* parameter should equal to <xref:System.Transactions.EnlistmentOptions.None> to ensure that a single phase commit would be performed.</span></span>

<span data-ttu-id="6069d-151">Puesto que la interfaz <xref:System.Transactions.ISinglePhaseNotification> deriva de la interfaz <xref:System.Transactions.IEnlistmentNotification>, si RM no es elegible para la confirmación de la fase única, todavía puede recibir las dos notificaciones de confirmación de fase.</span><span class="sxs-lookup"><span data-stu-id="6069d-151">Since the <xref:System.Transactions.ISinglePhaseNotification> interface derives from the <xref:System.Transactions.IEnlistmentNotification> interface, if your RM is not eligible for single phase commit, it can still receive the two phase commit notifications.</span></span> <span data-ttu-id="6069d-152">Si RM recibe una notificación <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> de la TM, debería intentar hacer el trabajo necesario para confirmar y correspondientemente informar al administrador de transacciones si la transacción será confirmada o revertirla llamando al método <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>o <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> en el parámetro <xref:System.Transactions.SinglePhaseEnlistment>.</span><span class="sxs-lookup"><span data-stu-id="6069d-152">If your RM receives a <xref:System.Transactions.ISinglePhaseNotification.SinglePhaseCommit%2A> notification from the TM, it should try to do the work necessary for it to commit and correspondingly inform the transaction manager if the transaction is to be committed or rolled back by calling the <xref:System.Transactions.SinglePhaseEnlistment.Committed%2A>, <xref:System.Transactions.SinglePhaseEnlistment.Aborted%2A>, or <xref:System.Transactions.SinglePhaseEnlistment.InDoubt%2A> method on the <xref:System.Transactions.SinglePhaseEnlistment> parameter.</span></span> <span data-ttu-id="6069d-153">Una respuesta de <xref:System.Transactions.Enlistment.Done%2A> en la inscripción en esta copia intermedia implica la semántica ReadOnly.</span><span class="sxs-lookup"><span data-stu-id="6069d-153">A response of <xref:System.Transactions.Enlistment.Done%2A> on the enlistment at this stage implies ReadOnly semantics.</span></span> <span data-ttu-id="6069d-154">Por consiguiente, no debería contestar <xref:System.Transactions.Enlistment.Done%2A> sumándose a cualquiera de los otros métodos.</span><span class="sxs-lookup"><span data-stu-id="6069d-154">Therefore, you should not reply <xref:System.Transactions.Enlistment.Done%2A> in addition to any of the other methods.</span></span>

<span data-ttu-id="6069d-155">Si solo se da una inscripción volátil y no duradera, ésta recibe una notificación SPC.</span><span class="sxs-lookup"><span data-stu-id="6069d-155">If there is only one volatile enlistment and no durable enlistment, the volatile enlistment receives SPC notification.</span></span> <span data-ttu-id="6069d-156">Si hay varias inscripciones volátiles y solo una duradera, las inscripciones volátiles reciben una notificación SPC.</span><span class="sxs-lookup"><span data-stu-id="6069d-156">If there are any volatile enlistments and only one durable enlistment, the volatile enlistments receive 2PC.</span></span> <span data-ttu-id="6069d-157">Cuando se completa, la inscripción duradera recibe SPC.</span><span class="sxs-lookup"><span data-stu-id="6069d-157">When it is completed, the durable enlistment receives SPC.</span></span>

## <a name="see-also"></a><span data-ttu-id="6069d-158">Consulte también:</span><span class="sxs-lookup"><span data-stu-id="6069d-158">See also</span></span>

- [<span data-ttu-id="6069d-159">Dar de alta los recursos como participantes en una transacción</span><span class="sxs-lookup"><span data-stu-id="6069d-159">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)
- [<span data-ttu-id="6069d-160">Confirmar una transacción en fase única y múltiple</span><span class="sxs-lookup"><span data-stu-id="6069d-160">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)
